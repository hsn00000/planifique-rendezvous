{% extends 'base_public.html.twig' %}

{% block title %}Coordonnées - {{ event.titre }}{% endblock %}

{% block body %}
    <div class="d-flex align-items-center justify-content-center min-vh-100 py-5" style="background-color: #f8f9fa;">

        <div class="card border-0 shadow-lg overflow-hidden w-100" style="max-width: 1000px; border-radius: 16px;">
            <div class="row g-0">

                {# --- GAUCHE : INFO ÉVÉNEMENT --- #}
                <div class="col-lg-5 text-white p-5 d-flex flex-column justify-content-center text-center"
                     style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);">

                    <div class="mb-4">
                        <img src="{{ asset('img/logo.png') }}" alt="Planifique" style="height: 40px; filter: brightness(0) invert(1); opacity: 0.9;">
                    </div>

                    <h1 class="h4 fw-bold mb-2">{{ event.titre }}</h1>
                    <p class="opacity-75 small text-uppercase ls-1 mb-5">Détails du rendez-vous</p>

                    <div class="mb-5">
                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-white text-primary fw-bold mb-3 shadow-sm"
                             style="width: 70px; height: 70px; font-size: 1.8rem;">
                            {% if conseiller %}
                                {{ conseiller.firstName|first }}{{ conseiller.lastName|first }}
                            {% else %}
                                <i class="fas fa-users"></i>
                            {% endif %}
                        </div>

                        <div class="small opacity-75 text-uppercase ls-1 mb-1">
                            {% if conseiller %}Votre conseiller{% else %}Votre équipe{% endif %}
                        </div>
                        <div class="fs-5 fw-bold">
                            {% if conseiller %}
                                {{ conseiller.firstName }} {{ conseiller.lastName }}
                            {% else %}
                                {{ event.groupe.nom|default('Planifique') }}
                            {% endif %}
                        </div>
                    </div>

                    <div class="vstack gap-4 opacity-90">
                        <div>
                            <span class="opacity-50 text-uppercase small d-block mb-1">Durée</span>
                            <span class="fw-bold">
                                {% set hours = (event.duree / 60)|round(0, 'floor') %}
                                {% set minutes = event.duree % 60 %}
                                {% if hours > 0 %}{{ hours }} h {% endif %}{{ minutes > 0 ? minutes ~ ' min' : '' }}
                            </span>
                        </div>
                    </div>
                </div>

                {# --- DROITE : FORMULAIRE --- #}
                <div class="col-lg-7 bg-white p-5">

                    <div class="text-center mb-5">
                        <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-bold mb-3 text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">
                            Étape 1 sur 3
                        </span>

                        <h2 class="h3 fw-bold text-dark mt-2">Vos coordonnées</h2>
                        <p class="text-muted small">Remplissez ce formulaire pour accéder au calendrier.</p>
                    </div>

                    {{ form_start(form, {'attr': {'data-turbo': 'false', 'id': 'booking-form'}}) }}

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            {{ form_label(form.prenom, 'Prénom', {'label_attr': {'class': 'form-label fw-bold small text-secondary'}}) }}
                            {{ form_widget(form.prenom, {'attr': {'class': 'form-control form-control-lg'}}) }}
                            {{ form_errors(form.prenom) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_label(form.nom, 'Nom', {'label_attr': {'class': 'form-label fw-bold small text-secondary'}}) }}
                            {{ form_widget(form.nom, {'attr': {'class': 'form-control form-control-lg'}}) }}
                            {{ form_errors(form.nom) }}
                        </div>
                    </div>

                    <div class="mb-4">
                        {{ form_label(form.email, 'Email professionnel', {'label_attr': {'class': 'form-label fw-bold small text-secondary'}}) }}
                        {{ form_widget(form.email, {'attr': {'class': 'form-control form-control-lg'}}) }}
                        {{ form_errors(form.email) }}
                    </div>

                    <div class="mb-4">
                        {{ form_label(form.telephone, 'Téléphone mobile', {'label_attr': {'class': 'form-label fw-bold small text-secondary'}}) }}
                        {{ form_widget(form.telephone, {'attr': {'class': 'form-control form-control-lg'}}) }}
                        {{ form_errors(form.telephone) }}
                    </div>

                    <hr class="my-5 opacity-10">

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">Lieu du rendez-vous</label>
                        {{ form_widget(form.typeLieu, {'attr': {'class': 'form-select form-select-lg', 'id': 'select-lieu'}}) }}
                    </div>

                    <div id="field-adresse-container" class="d-none mb-4">
                        <label class="form-label fw-bold small text-secondary">Adresse complète</label>
                        {{ form_widget(form.adresse, {'attr': {'class': 'form-control form-control-lg', 'placeholder': 'N°, Rue, Code Postal, Ville'}}) }}
                        {{ form_errors(form.adresse) }}
                    </div>

                    <div class="d-grid mt-5">
                        <button type="submit" id="submit-btn" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold text-uppercase ls-1 shadow-sm position-relative" style="min-height: 56px;">
                            <span id="submit-text">Suivant : Choisir l'heure <i class="fas fa-arrow-right ms-2"></i></span>
                            <span id="submit-loader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);"></span>
                        </button>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        {# Loader plein écran avec ciel étoilé nocturne #}
        <div id="form-loading" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" style="z-index: 10000; pointer-events: auto; overflow-y: auto; background: #000000;">
            {# Ciel étoilé avec étoiles qui brillent #}
            <div class="starry-sky">
                <canvas id="stars-canvas"></canvas>
            </div>
            
            <div class="container py-5 position-relative" style="z-index: 1;">
                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center mb-5">
                        {# Logo Planifique animé ou spinner élégant #}
                        <div class="loading-logo-wrapper mb-4" style="animation: fadeInScale 0.8s ease-out;">
                            <div class="loading-logo">
                                <img src="{{ asset('img/logo.png') }}" alt="Planifique" style="height: 60px; width: auto; filter: brightness(0) invert(1); animation: gentlePulse 2s ease-in-out infinite;">
                            </div>
                        </div>
                        
                        {# Titre avec effet de typing #}
                        <h4 class="fw-bold text-white mb-3 loading-title" style="font-size: 1.75rem; animation: fadeInUp 0.8s ease-out 0.3s both; text-shadow: 0 0 20px rgba(37, 99, 235, 0.5);">
                            Planifique prépare votre calendrier
                        </h4>
                        
                        {# Texte dynamique qui change #}
                        <p class="text-white-50 mb-4 loading-text" style="min-height: 2.5rem; animation: fadeInUp 0.8s ease-out 0.5s both;">
                            <span class="loading-text-item active">Nous vérifions les disponibilités...</span>
                        </p>
                        
                        {# Barre de progression animée #}
                        <div class="progress-wrapper mx-auto" style="max-width: 300px; animation: fadeInUp 0.8s ease-out 0.7s both;">
                            <div class="progress-bar-animated">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {# Services Planifique avec animations améliorées #}
                <div class="row justify-content-center mt-5">
                    <div class="col-lg-10">
                        <h5 class="fw-bold text-white text-center mb-4 service-title" style="animation: fadeInUp 0.8s ease-out 0.9s both; text-shadow: 0 0 15px rgba(37, 99, 235, 0.4);">Nos services d'accompagnement</h5>
                        <div class="row g-4 align-items-stretch">
                            <div class="col-md-4 d-flex">
                                <div class="card border-0 shadow-lg w-100 text-center p-4 service-card" style="border-radius: 16px; animation: fadeInUpScale 0.8s ease-out 1.1s both; background: white; display: flex; flex-direction: column; overflow: hidden;">
                                    <div class="service-icon-wrapper">
                                        <i class="fas fa-piggy-bank text-primary service-icon" style="font-size: 2.8rem;"></i>
                                    </div>
                                    <h6 class="fw-bold mb-3 text-dark" style="flex-shrink: 0; font-size: 1.1rem;">Gestion de Patrimoine</h6>
                                    <p class="text-muted small mb-0" style="flex-grow: 1; line-height: 1.6;">Accompagnement sur-mesure pour optimiser votre patrimoine et atteindre vos objectifs financiers.</p>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex">
                                <div class="card border-0 shadow-lg w-100 text-center p-4 service-card" style="border-radius: 16px; animation: fadeInUpScale 0.8s ease-out 1.3s both; background: white; display: flex; flex-direction: column; overflow: hidden;">
                                    <div class="service-icon-wrapper">
                                        <i class="fas fa-calculator text-primary service-icon" style="font-size: 2.8rem;"></i>
                                    </div>
                                    <h6 class="fw-bold mb-3 text-dark" style="flex-shrink: 0; font-size: 1.1rem;">Optimisation Fiscale</h6>
                                    <p class="text-muted small mb-0" style="flex-grow: 1; line-height: 1.6;">Transformez la complexité fiscale en opportunités pour résidents suisses et frontaliers.</p>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex">
                                <div class="card border-0 shadow-lg w-100 text-center p-4 service-card" style="border-radius: 16px; animation: fadeInUpScale 0.8s ease-out 1.5s both; background: white; display: flex; flex-direction: column; overflow: hidden;">
                                    <div class="service-icon-wrapper">
                                        <i class="fas fa-umbrella text-primary service-icon" style="font-size: 2.8rem;"></i>
                                    </div>
                                    <h6 class="fw-bold mb-3 text-dark" style="flex-shrink: 0; font-size: 1.1rem;">Sécurisation Retraite</h6>
                                    <p class="text-muted small mb-0" style="flex-grow: 1; line-height: 1.6;">Conseil sur-mesure pour votre assurance santé et le retrait de votre 2e pilier.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function initAddressLogic() {
            let selectLieu = document.getElementById('select-lieu');
            if (!selectLieu) selectLieu = document.querySelector('select[id$="typeLieu"]');
            const containerAdresse = document.getElementById('field-adresse-container');

            if (!selectLieu || !containerAdresse) return;

            const inputAdresse = containerAdresse.querySelector('input');
            const toggleAdresse = () => {
                const val = selectLieu.value;
                if (val && val.toLowerCase().includes('domicile')) {
                    containerAdresse.classList.remove('d-none');
                    if(inputAdresse) inputAdresse.required = true;
                } else {
                    containerAdresse.classList.add('d-none');
                    if(inputAdresse) {
                        inputAdresse.value = '';
                        inputAdresse.required = false;
                    }
                }
            };
            selectLieu.addEventListener('change', toggleAdresse);
            toggleAdresse();
        }

        // Gérer le loader lors de la soumission du formulaire
        const bookingForm = document.getElementById('booking-form');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                const btn = document.getElementById('submit-btn');
                const text = document.getElementById('submit-text');
                const loader = document.getElementById('submit-loader');
                const formLoader = document.getElementById('form-loading');

                // Désactiver le bouton et afficher les loaders
                if (btn) btn.disabled = true;
                if (text) text.classList.add('d-none');
                if (loader) loader.classList.remove('d-none');
                if (formLoader) {
                    formLoader.classList.remove('d-none');
                    formLoader.style.display = 'flex';
                }
            });
        }
        
        // Gérer le retour en arrière du navigateur
        window.addEventListener('pageshow', function(event) {
            // Si la page est chargée depuis le cache (retour en arrière)
            if (event.persisted) {
                const formLoader = document.getElementById('form-loading');
                const btn = document.getElementById('submit-btn');
                const text = document.getElementById('submit-text');
                const loader = document.getElementById('submit-loader');
                
                // Masquer le loader
                if (formLoader) {
                    formLoader.classList.add('d-none');
                    formLoader.style.display = 'none';
                }
                
                // Réactiver le bouton si nécessaire
                if (btn) {
                    btn.disabled = false;
                }
                if (text) {
                    text.classList.remove('d-none');
                }
                if (loader) {
                    loader.classList.add('d-none');
                }
            }
        });
        
        // Gérer aussi le popstate (retour en arrière)
        window.addEventListener('popstate', function(event) {
            const formLoader = document.getElementById('form-loading');
            const btn = document.getElementById('submit-btn');
            const text = document.getElementById('submit-text');
            const loader = document.getElementById('submit-loader');
            
            if (formLoader) {
                formLoader.classList.add('d-none');
                formLoader.style.display = 'none';
            }
            
            // Réactiver le bouton
            if (btn) {
                btn.disabled = false;
            }
            if (text) {
                text.classList.remove('d-none');
            }
            if (loader) {
                loader.classList.add('d-none');
            }
        });

        document.addEventListener('DOMContentLoaded', initAddressLogic);
        document.addEventListener('turbo:load', initAddressLogic);
    </script>

    <style>
        .ls-1 { letter-spacing: 1px; }
        .form-control-lg, .form-select-lg {
            font-size: 1rem; padding: 0.8rem 1rem;
            border-radius: 8px; background-color: #f8f9fa; border: 1px solid #dee2e6;
        }
        .form-control-lg:focus, .form-select-lg:focus {
            background-color: #fff; border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        
        /* Animations améliorées */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeInUpScale {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.6;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.4;
            }
        }
        
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(37, 99, 235, 0.6);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes particleFloat {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        
        /* Barre de progression */
        .progress-wrapper {
            margin-top: 2rem;
        }
        
        .progress-bar-animated {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #3b82f6, #60a5fa, #2563eb);
            background-size: 200% 100%;
            border-radius: 10px;
            animation: shimmer 2s linear infinite, progressFill 3s ease-in-out infinite;
            width: 0%;
        }
        
        @keyframes progressFill {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        /* Texte dynamique */
        .loading-text-item {
            display: inline-block;
            animation: fadeInOut 3s ease-in-out infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Ciel étoilé nocturne */
        .starry-sky {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            background: #000000;
            margin: 0;
            padding: 0;
        }
        
        #stars-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            margin: 0;
            padding: 0;
        }
        
        @keyframes gentlePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        
        .loading-logo-wrapper {
            display: inline-block;
            position: relative;
            z-index: 10;
        }
        
        .loading-logo {
            position: relative;
            display: inline-block;
            z-index: 10;
        }
        
        .loading-logo img {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 10;
        }
        
        /* Cartes de services améliorées */
        .service-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            min-height: 280px;
            background: white !important;
        }
        
        .service-card::before,
        .service-card::after {
            display: none !important;
            content: none !important;
        }
        
        .service-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1) !important;
        }
        
        .service-card > * {
            position: relative;
            z-index: 1;
        }
        
        .service-icon-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem auto;
            width: 100%;
            height: 80px;
            overflow: hidden;
            background: transparent;
        }
        
        .service-icon {
            position: relative;
            z-index: 2;
            margin: 0;
            padding: 0;
            animation: float 3s ease-in-out infinite;
            transition: transform 0.3s ease;
            display: inline-block;
            background: transparent !important;
            box-shadow: none !important;
        }
        
        .service-card:hover .service-icon {
            transform: scale(1.2) rotate(5deg);
        }
        
        .service-card:nth-child(1) .service-icon {
            animation-delay: 0s;
        }
        
        .service-card:nth-child(2) .service-icon {
            animation-delay: 0.3s;
        }
        
        .service-card:nth-child(3) .service-icon {
            animation-delay: 0.6s;
        }
    </style>
    
    <script>
        // Animation de texte dynamique et ciel étoilé
        document.addEventListener('DOMContentLoaded', function() {
            // Animation de texte dynamique
            const loadingText = document.querySelector('.loading-text-item');
            if (loadingText) {
                const texts = [
                    'Nous vérifions les disponibilités...',
                    'Analyse des créneaux disponibles...',
                    'Préparation de votre calendrier...',
                    'Presque terminé...'
                ];
                let currentIndex = 0;
                
                setInterval(function() {
                    currentIndex = (currentIndex + 1) % texts.length;
                    loadingText.style.transition = 'opacity 0.3s ease';
                    loadingText.style.opacity = '0';
                    setTimeout(function() {
                        loadingText.textContent = texts[currentIndex];
                        loadingText.style.opacity = '1';
                    }, 300);
                }, 2500);
            }
            
            // Ciel étoilé nocturne avec étoiles qui brillent intensément
            const canvas = document.getElementById('stars-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const stars = [];
                const numStars = 80; // Moins d'étoiles mais qui brillent beaucoup plus
                
                // Ajuster la taille du canvas
                function resizeCanvas() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                // Créer les étoiles - moins nombreuses mais beaucoup plus brillantes
                for (let i = 0; i < numStars; i++) {
                    const rand = Math.random();
                    const isBrightStar = rand < 0.25; // 25% des étoiles sont très brillantes
                    const isMediumStar = rand >= 0.25 && rand < 0.55; // 30% des étoiles sont moyennement brillantes
                    
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        radius: isBrightStar ? Math.random() * 3.5 + 2.0 : (isMediumStar ? Math.random() * 2.0 + 1.2 : Math.random() * 1.2 + 0.5),
                        opacity: isBrightStar ? Math.random() * 0.3 + 0.8 : (isMediumStar ? Math.random() * 0.3 + 0.6 : Math.random() * 0.3 + 0.4),
                        twinkleSpeed: isBrightStar ? Math.random() * 0.05 + 0.04 : (isMediumStar ? Math.random() * 0.04 + 0.03 : Math.random() * 0.03 + 0.02),
                        twinklePhase: Math.random() * Math.PI * 2,
                        isBright: isBrightStar,
                        isMedium: isMediumStar
                    });
                }
                
                // Fonction d'animation
                function animateStars() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    stars.forEach(star => {
                        // Effet de scintillement intense - étoiles qui brillent beaucoup plus
                        star.twinklePhase += star.twinkleSpeed;
                        const twinkleRange = star.isBright ? 0.8 : (star.isMedium ? 0.6 : 0.4); // Variation encore plus prononcée
                        const twinkle = Math.sin(star.twinklePhase) * twinkleRange + (1 - twinkleRange);
                        const currentOpacity = Math.min(star.opacity * twinkle, 1);
                        
                        if (star.isBright) {
                            // Étoiles très brillantes avec un glow très intense
                            const gradient = ctx.createRadialGradient(
                                star.x, star.y, 0,
                                star.x, star.y, star.radius * 6
                            );
                            gradient.addColorStop(0, `rgba(147, 197, 253, ${currentOpacity})`);
                            gradient.addColorStop(0.1, `rgba(96, 165, 250, ${currentOpacity * 0.95})`);
                            gradient.addColorStop(0.25, `rgba(59, 130, 246, ${currentOpacity * 0.85})`);
                            gradient.addColorStop(0.4, `rgba(37, 99, 235, ${currentOpacity * 0.6})`);
                            gradient.addColorStop(0.6, `rgba(37, 99, 235, ${currentOpacity * 0.3})`);
                            gradient.addColorStop(0.8, `rgba(59, 130, 246, ${currentOpacity * 0.15})`);
                            gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
                            
                            ctx.fillStyle = gradient;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 6, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Halo intermédiaire très brillant
                            const gradient2 = ctx.createRadialGradient(
                                star.x, star.y, 0,
                                star.x, star.y, star.radius * 4
                            );
                            gradient2.addColorStop(0, `rgba(191, 219, 254, ${currentOpacity * 1.0})`);
                            gradient2.addColorStop(0.3, `rgba(147, 197, 253, ${currentOpacity * 0.8})`);
                            gradient2.addColorStop(0.6, `rgba(96, 165, 250, ${currentOpacity * 0.5})`);
                            gradient2.addColorStop(1, 'rgba(37, 99, 235, 0)');
                            
                            ctx.fillStyle = gradient2;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 4, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Point central très brillant
                            ctx.fillStyle = `rgba(191, 219, 254, ${currentOpacity})`;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 1.2, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Point blanc très brillant au centre
                            ctx.fillStyle = `rgba(255, 255, 255, ${Math.min(currentOpacity * 1.2, 1)})`;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 0.7, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Petit point blanc pur au centre
                            ctx.fillStyle = `rgba(255, 255, 255, 1)`;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 0.3, 0, Math.PI * 2);
                            ctx.fill();
                        } else if (star.isMedium) {
                            // Étoiles moyennement brillantes mais bien visibles
                            const gradient = ctx.createRadialGradient(
                                star.x, star.y, 0,
                                star.x, star.y, star.radius * 4
                            );
                            gradient.addColorStop(0, `rgba(96, 165, 250, ${currentOpacity})`);
                            gradient.addColorStop(0.25, `rgba(59, 130, 246, ${currentOpacity * 0.8})`);
                            gradient.addColorStop(0.5, `rgba(37, 99, 235, ${currentOpacity * 0.5})`);
                            gradient.addColorStop(0.75, `rgba(37, 99, 235, ${currentOpacity * 0.25})`);
                            gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
                            
                            ctx.fillStyle = gradient;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 4, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Point central brillant
                            ctx.fillStyle = `rgba(96, 165, 250, ${currentOpacity})`;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Point blanc au centre
                            ctx.fillStyle = `rgba(255, 255, 255, ${currentOpacity * 0.8})`;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 0.4, 0, Math.PI * 2);
                            ctx.fill();
                        } else {
                            // Petites étoiles mais toujours bien visibles
                            const gradient = ctx.createRadialGradient(
                                star.x, star.y, 0,
                                star.x, star.y, star.radius * 3
                            );
                            gradient.addColorStop(0, `rgba(59, 130, 246, ${currentOpacity})`);
                            gradient.addColorStop(0.3, `rgba(37, 99, 235, ${currentOpacity * 0.7})`);
                            gradient.addColorStop(0.6, `rgba(37, 99, 235, ${currentOpacity * 0.4})`);
                            gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
                            
                            ctx.fillStyle = gradient;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius * 3, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Point central
                            ctx.fillStyle = `rgba(59, 130, 246, ${currentOpacity})`;
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    });
                    
                    requestAnimationFrame(animateStars);
                }
                
                animateStars();
            }
        });
    </script>
{% endblock %}
