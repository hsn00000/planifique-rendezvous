{% extends 'base_public.html.twig' %}

{% block title %}R√©capitulatif - Planifique{% endblock %}

{% block body %}
    <div class="container d-flex align-items-center justify-content-center min-vh-100 py-5">
        <div class="card border-0 shadow-lg" style="max-width: 650px; width: 100%; border-radius: 16px; overflow: hidden;">

            {# En-t√™te simple avec logo #}
            <div class="p-4 text-center border-bottom bg-white">
                <img src="{{ asset('img/logo.png') }}" alt="Planifique" style="height: 40px; width: auto;" class="mb-3">
                <h1 class="h4 fw-bold text-dark mb-1">R√©capitulatif</h1>
                <p class="text-muted small mb-0">V√©rifiez les informations avant de confirmer</p>
            </div>

            <div class="p-4 p-md-5 bg-white">

                {# Conseiller #}
                <div class="d-flex align-items-center mb-4 pb-4 border-bottom">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 text-primary fw-bold me-3" style="width: 55px; height: 55px; font-size: 1.3rem;">
                        {% if conseiller %}
                            {{ conseiller.firstName|first }}{{ conseiller.lastName|first }}
                        {% else %}
                            <i class="fas fa-users"></i>
                        {% endif %}
                    </div>
                    <div>
                        <div class="small text-muted text-uppercase fw-bold mb-1">Rendez-vous avec</div>
                        <div class="h5 fw-bold text-dark mb-0">
                            {% if conseiller %}
                                {{ conseiller.firstName }} {{ conseiller.lastName }}
                            {% else %}
                                Votre √©quipe
                                <div class="text-muted small fw-normal mt-1">{{ event.groupe.nom|default('Service Client') }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# Type d'√©v√©nement #}
                <div class="mb-4">
                    <div class="small text-muted text-uppercase fw-bold mb-2">Type de rendez-vous</div>
                    <div class="fw-bold text-dark">{{ event.titre }}</div>
                </div>

                {# Date et Heure - Style √©pur√© #}
                <div class="mb-4">
                    <div class="d-flex align-items-start mb-3">
                        <i class="far fa-calendar-alt text-primary me-3 mt-1" style="width: 20px;"></i>
                        <div>
                            <div class="small text-muted text-uppercase fw-bold mb-1">Date</div>
                            <div class="fw-bold text-dark text-capitalize">
                                {{ dateDebut|format_datetime(pattern="EEEE d MMMM yyyy", locale='fr') }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-start mb-3">
                        <i class="far fa-clock text-primary me-3 mt-1" style="width: 20px;"></i>
                        <div>
                            <div class="small text-muted text-uppercase fw-bold mb-1">Horaire</div>
                            <div class="fw-bold text-primary fs-5">{{ dateDebut|date('H:i') }} - {{ dateFin|date('H:i') }}</div>
                            <div class="text-muted small mt-1">
                                Dur√©e :
                                {% set hours = (event.duree / 60)|round(0, 'floor') %}
                                {% set minutes = event.duree % 60 %}
                                <span class="fw-bold text-dark">
                                    {% if hours > 0 %}{{ hours }} h {% endif %}{{ minutes > 0 ? minutes ~ ' min' : '' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex align-items-start">
                        <i class="fas fa-map-marker-alt text-primary me-3 mt-1" style="width: 20px;"></i>
                        <div>
                            <div class="small text-muted text-uppercase fw-bold mb-1">Lieu</div>
                            <div class="fw-bold text-dark">
                                {% if lieu == 'visio' or lieu == 'Visioconf√©rence' %}
                                    En visioconf√©rence (Teams/Zoom)
                                {% elseif lieu == 'Cabinet-geneve' %}
                                    Cabinet de Gen√®ve
                                {% elseif lieu == 'Cabinet-archamps' %}
                                    Cabinet d'Archamps
                                {% else %}
                                    {{ lieu }}
                                {% endif %}
                            </div>
                            {% if lieu == 'visio' or lieu == 'Visioconf√©rence' %}
                                <div class="alert alert-info mt-3 mb-0" style="background-color: #eff6ff; border-left: 4px solid #2563eb; border-radius: 4px; padding: 12px;">
                                    <div class="fw-bold text-primary mb-1" style="font-size: 14px;">
                                        üìß Connexion en tant qu'invit√©
                                    </div>
                                    <div class="text-dark small" style="line-height: 1.5;">
                                        Vous recevrez un lien de connexion par email. Vous pourrez vous connecter en tant qu'invit√© gr√¢ce √† votre adresse email : <strong>{{ client.email }}</strong>
                                    </div>
                                </div>
                            {% endif %}
                            {% if client.adresse is defined and client.adresse %}
                                <div class="text-muted small mt-1">{{ client.adresse }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# Coordonn√©es client #}
                <div class="bg-light p-3 rounded mb-4">
                    <div class="small text-muted text-uppercase fw-bold mb-2">Vos coordonn√©es</div>
                    <div class="fw-bold text-dark mb-1">{{ client.prenom }} {{ client.nom }}</div>
                    <div class="text-muted small">{{ client.email }}</div>
                    <div class="text-muted small">{{ client.telephone }}</div>
                </div>

                {# Boutons d'action #}
                <div class="d-grid gap-2">
                    <form id="validateForm" action="{{ path('app_booking_finalize', {'eventId': event.id}) }}" method="POST">
                        <input type="hidden" name="date" value="{{ dateParam }}">
                        {% if userIdParam %}
                            <input type="hidden" name="user" value="{{ userIdParam }}">
                        {% endif %}
                        <input type="hidden" name="lieu" value="{{ lieu }}">
                        <button type="submit" id="validateBtn" class="btn btn-primary btn-lg rounded-pill fw-bold py-3 shadow-sm w-100 position-relative" style="min-height: 56px;">
                            <span id="validateText">
                                <i class="fas fa-check-circle me-2"></i>Confirmer ce rendez-vous
                            </span>
                            <span id="validateLoader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);"></span>
                        </button>
                    </form>

                    <a href="{{ path('app_booking_calendar', {'eventId': event.id, 'user': userIdParam}) }}"
                       class="btn btn-outline-secondary btn-lg rounded-pill fw-bold py-3" data-turbo="false">
                        <i class="fas fa-arrow-left me-2"></i>Retour au calendrier
                    </a>
                </div>

            </div>
        </div>

        {# Overlay de chargement #}
        <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none d-flex align-items-center justify-content-center" style="background: rgba(255, 255, 255, 0.95); z-index: 9999; backdrop-filter: blur(4px);">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <h5 class="fw-bold text-dark mb-2">Validation en cours</h5>
                <p class="text-muted small mb-0">Veuillez patienter...</p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('validateForm').addEventListener('submit', function(e) {
            const btn = document.getElementById('validateBtn');
            const text = document.getElementById('validateText');
            const loader = document.getElementById('validateLoader');
            const overlay = document.getElementById('loadingOverlay');

            // Log pour debug AVANT de d√©sactiver
            console.log('=== D√âBUT VALIDATION ===');
            console.log('Formulaire action:', this.action);
            console.log('M√©thode:', this.method);
            console.log('Date param:', '{{ dateParam }}');
            
            // D√©sactiver le bouton et afficher le loader
            btn.disabled = true;
            btn.style.opacity = '0.7';
            text.classList.add('d-none');
            loader.classList.remove('d-none');
            overlay.classList.remove('d-none');
            
            // Le formulaire va soumettre normalement, le loader restera jusqu'√† la redirection
            // Ne pas emp√™cher la soumission avec e.preventDefault()
        });
    </script>
{% endblock %}
