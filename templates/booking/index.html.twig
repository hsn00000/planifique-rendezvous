{% extends 'base_public.html.twig' %}

{% block title %}Réserver - {{ event.titre }}{% endblock %}

{% block body %}
    <div class="container" style="max-width: 1060px;">
        <div class="card border-0 shadow-calendly fade-in-up overflow-hidden" style="border-radius: 8px; min-height: 650px;">
            <div class="row g-0 h-100">

                {# --- COLONNE GAUCHE (Récap) --- #}
                <div class="col-lg-4 p-5 d-flex flex-column border-end bg-white">
                    <div class="d-flex align-items-center mb-5">
                        <img src="{{ asset('img/logo.png') }}" width="30" class="me-2">
                        <span class="fw-bold text-dark text-uppercase ls-1 small">Planifique</span>
                    </div>

                    <div class="mb-2">
                        <p class="text-muted small fw-bold mb-1 text-uppercase">Conseiller</p>
                        <h2 class="h5 fw-bold text-dark mb-0">{{ conseiller.firstName }} {{ conseiller.lastName }}</h2>
                    </div>

                    <h1 class="h3 fw-bold text-dark mb-4">{{ event.titre }}</h1>

                    <div class="d-flex flex-column gap-3 text-secondary mt-2">
                        <div class="d-flex align-items-start">
                            <div style="width: 24px;" class="me-2 text-center pt-1"><i class="fa-regular fa-clock fs-5"></i></div>
                            <span class="fw-bold text-dark">
                            {% set hours = (event.duree / 60)|round(0, 'floor') %}{% set minutes = event.duree % 60 %}
                                {% if hours > 0 %}{{ hours }} h {% endif %}{{ minutes > 0 ? minutes ~ ' min' : '' }}
                        </span>
                        </div>
                    </div>
                </div>

                {# --- COLONNE DROITE (Calendrier & Slots) --- #}
                <div class="col-lg-8 p-5 bg-white d-flex flex-column">
                    <h3 class="h4 fw-bold text-dark mb-4">Sélectionner une date et heure</h3>

                    <div class="row h-100">
                        {# Partie Calendrier #}
                        <div class="col-md-7 border-end pe-4">
                            <div id="calendar-grid" class="d-grid" style="grid-template-columns: repeat(7, 1fr); gap: 5px;">
                                {# En-tête jours #}
                                {% for day in ['L', 'M', 'M', 'J', 'V', 'S', 'D'] %}
                                    <div class="text-center small fw-bold text-muted pb-2">{{ day }}</div>
                                {% endfor %}

                                {# Génération des jours cliquables #}
                                {% for dayKey, slots in slotsByDay %}
                                    <button type="button"
                                            class="btn btn-outline-primary border-0 rounded-circle day-btn p-0"
                                            style="width: 40px; height: 40px; margin: auto;"
                                            data-day="{{ dayKey }}"
                                            onclick="showSlots('{{ dayKey }}')">
                                        {{ dayKey|date('j') }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>

                        {# Partie Heures (Cachée par défaut) #}
                        <div class="col-md-5 ps-4" id="slots-container">
                            <div class="text-center text-muted mt-5" id="no-day-selected">
                                <p class="small">Sélectionnez un jour pour voir les créneaux.</p>
                            </div>

                            <div id="slots-list" class="d-none" style="max-height: 400px; overflow-y: auto;">
                                <h6 class="fw-bold mb-3" id="selected-date-label">Date</h6>
                                <div id="slots-buttons" class="d-flex flex-column gap-2">
                                    {# Les boutons d'heures seront injectés ici en JS #}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto pt-3 border-top d-flex justify-content-between">
                        <div class="small text-muted"><i class="fa-solid fa-earth-americas me-1"></i> Europe/Paris</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {# SCRIPT DYNAMIQUE #}
    <script>
        const slotsData = {{ slotsByDay|json_encode|raw }};

        function showSlots(day) {
            document.getElementById('no-day-selected').classList.add('d-none');
            document.getElementById('slots-list').classList.remove('d-none');

            const label = new Date(day).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('selected-date-label').innerText = label;

            const buttonsContainer = document.getElementById('slots-buttons');
            buttonsContainer.innerHTML = '';

            if (slotsData[day] && slotsData[day].length > 0) {
                slotsData[day].forEach(time => {
                    const btn = document.createElement('a');
                    btn.href = `{{ path('app_booking_confirm', {'event': event.id, 'user': conseiller.id}) }}?date=${day} ${time}`;
                    btn.className = "btn btn-outline-primary fw-bold py-2";
                    btn.innerText = time;
                    buttonsContainer.appendChild(btn);
                });
            } else {
                buttonsContainer.innerHTML = '<p class="text-danger small">Aucun créneau disponible.</p>';
            }
        }
    </script>

    <style>
        .day-btn:hover { background-color: #e0e7ff; color: #2563eb; }
        .day-btn.active { background-color: #2563eb; color: white; }
        #slots-list::-webkit-scrollbar { width: 5px; }
        #slots-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
{% endblock %}
